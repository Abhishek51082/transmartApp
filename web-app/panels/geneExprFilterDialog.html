<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Gene Expression Filter Dialog</title>
    <style>
        .ui-autocomplete {
            max-height: 100px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
            /* add padding to account for vertical scrollbar */
            padding-right: 20px;
        }
        .ui-slider {
            width: 130px;
            margin: 10px;
        }
    </style>
</head>
<body>
<script type="text/javascript">

    var geneExprFilterValues;
    var geneExprSliderFactor = 1000;
    // relative positions of low and high handle
    var geneExprSliderLowHandleRatio = 0;
    var geneExprSliderHighHandleRatio = 1;

    jQuery(document).ready(function() {
                addOmicsFilterGeneSearchAutocomplete();
                addRangeSlider();
                addMinMaxInputHandlers();
            }
    );

    function addMinMaxInputHandlers() {
        jQuery("#expression-amount-min").blur(function(event) {
            var input = jQuery("#expression-amount-min");
            var value = input.val();
            if (!jQuery.isNumeric(value)) {
                input.val(geneExprFilterValues[0]);
            }
            else if (value < geneExprFilterValues[0]) {
                input.val(geneExprFilterValues[0]);
            }
            else if (value > jQuery("#expression-amount-max").val()) {
                input.val(jQuery("#expression-amount-max").val());
            }
            jQuery("#gene-expression-range").slider('values',0,input.val() * geneExprSliderFactor);
            geneExpFilterSliderUpdated();
        });

        jQuery("#expression-amount-max").blur(function(event) {
            var input = jQuery("#expression-amount-max");
            var value = input.val();
            if (!jQuery.isNumeric(value)) {
                input.val(geneExprFilterValues[geneExprFilterValues.length - 1]);
            }
            else if (value > geneExprFilterValues[geneExprFilterValues.length - 1]) {
                input.val(geneExprFilterValues[geneExprFilterValues.length - 1]);
            }
            else if (value < jQuery("#expression-amount-min").val()) {
                input.val(jQuery("#expression-amount-min").val());
            }
            jQuery("#gene-expression-range").slider('values',1,input.val() * geneExprSliderFactor);
            geneExpFilterSliderUpdated();
        });

        // let the enter key blur the text fields, thus updating the slider and subject counts

        jQuery("#expression-amount-min").keyup(function(e) {
           if (e.which == 13) {
               jQuery(this).blur();
           }
        });

        jQuery("#expression-amount-max").keyup(function(e) {
            if (e.which == 13) {
                jQuery(this).blur();
            }
        });

        // prevent enter key from closing the dialog
        /*
        jQuery("#expression-amount-min").keypress(function (e) {
            return e.which != 13;
        });



        jQuery("#expression-amount-max").keypress(function (e) {
            return e.which != 13;
        });*/
    }

    function addRangeSlider() {
        jQuery( "#gene-expression-range" ).slider({
            range: true,
            min: -2500,
            max: 2500,
            values: [ -2500, 2500 ],
            slide: function( event, ui ) {
                geneExpFilterSliderUpdated();
            }
        });
    }

    function geneExpFilterSliderUpdated() {
        var low = jQuery("#gene-expression-range").slider('values', 0) / geneExprSliderFactor;
        var high = jQuery("#gene-expression-range").slider('values', 1) / geneExprSliderFactor;
        jQuery("#expression-amount-min").val(low.toFixed(3));
        jQuery("#expression-amount-max").val(high.toFixed(3));
        jQuery( "#gene-expr-filter-subjectcount").html(geneExprFilterValues.filter(function (el, idx, array) {return el >= low;})
                        .filter(function(el, idx, array) {return el <= high;})
                        .length)
    }

    function addOmicsFilterGeneSearchAutocomplete() {
        var searchbox = jQuery("#gene-searchbox");
        searchbox.css({"max-height": "300px", "overflow-y": "auto", "overflow-x": "hidden", "padding-right": "20px"});
        searchbox.autocomplete({
            position:{my:"left top",at:"left bottom",collision:"none"},
            appendTo:"#geneExprFilterWindow",
            source: '', // showOmicsFilterDialog() will set this, since we need to know the platform id
            minLength:1,
            select: function(event, ui) {
                jQuery("#gene-searchbox").val(ui.item.label);
                showConceptDistributionHistogramForOmicsFilterComplete(null, getGeneExprFilterParams());
                showConceptDistributionHistogramForOmicsFilter(getGeneExprFilterParams());
            },
            focus: function(event, ui) {
                jQuery("#gene-searchbox").val(ui.item.label);
            },
            close: function(event, ui) {
                if (ui.item) {
                    jQuery("#gene-searchbox").val(ui.item.label);
                }
            }
        }).data("uiAutocomplete")._renderItem = function( ul, item ) {
            var resulta = '<a><span class="category-gene"><b>' + item.label + '</b>';
            if (item.synonyms != null) {
                resulta += (item.synonyms + '</a>');
            }
            else {
                resulta += '</a>';
            }

            return jQuery('<li></li>')
                    .data("item.autocomplete", item )
                    .append(resulta)
                    .appendTo(ul);
        };
    }

    function geneExprFilterProjectionChanged() {
        if (jQuery("#gene-searchbox").val() != "") {
            // get relative position of handles
            var slider = jQuery("#gene-expression-range");
            var low = slider.slider('values', 0);
            var high = slider.slider('values', 1);
            var min = slider.slider('option','min');
            var max = slider.slider('option','max');

            geneExprSliderLowHandleRatio = (low - min) / (max - min);
            geneExprSliderHighHandleRatio = (high - min) / (max - min);
            showConceptDistributionHistogramForOmicsFilterComplete(null, getGeneExprFilterParams());
            showConceptDistributionHistogramForOmicsFilter(getGeneExprFilterParams());
        }
    }

    function getGeneExprFilterParams() {
        var params = {
            selector: jQuery("#gene-searchbox").val(),
            value: jQuery("#expression-amount-min").val() + ":" + jQuery("#expression-amount-max").val(),
            operator: "BETWEEN",
            type: "Gene Expression",
            projection_type: jQuery("input[name=gene-expression-projection]:checked").val(),
            platform: jQuery("#gene-expr-filter-gplid").html(),
            hist_div: jQuery("#gene-expression-filter-histogram"),
            window: geneexprfilterwin,
            slider_rows: jQuery("[id^=gene-expression-slider-row]"),
            valuescallback: geneExprConceptValuesObtained,
            valuescallbackfailed: geneExprConceptValuesFailed
        };
        return params;
    }

    function geneExprConceptValuesObtained(values) {
        geneExprFilterValues = values;
        if (geneExprFilterValues.length > 0) {
            geneExprFilterValues.sort(function (a, b) {return a - b}); // sort numerically rather then string-based
            jQuery("[id^=gene-expression-slider-row]").css({'display': 'table-row'});
            jQuery("#gene-expression-range").slider('option',{'min': geneExprFilterValues[0] * geneExprSliderFactor, 'max': geneExprFilterValues[geneExprFilterValues.length - 1] * geneExprSliderFactor})
            jQuery("#gene-expression-range").slider('values', 0, (geneExprFilterValues[0] + geneExprSliderLowHandleRatio * (geneExprFilterValues[geneExprFilterValues.length - 1] - geneExprFilterValues[0])) * geneExprSliderFactor);
            jQuery("#gene-expression-range").slider('values', 1, (geneExprFilterValues[0] + geneExprSliderHighHandleRatio * (geneExprFilterValues[geneExprFilterValues.length - 1] - geneExprFilterValues[0])) * geneExprSliderFactor);
            geneExpFilterSliderUpdated();
        }
        else {
            jQuery("[id^=gene-expression-slider-row]").css({'display': 'none'});
            jQuery( "#expression-amount-min" ).val(0);
            jQuery( "#expression-amount-max" ).val(0);
            document.getElementById("gene-expression-filter-histogram").innerHTML = "No data is available for the given gene.";
            geneexprfilterwin.setHeight(140);
        }
    }

    function geneExprConceptValuesFailed(result) {
        jQuery("#gene-expression-slider-row").css({'display': 'none'});
        jQuery( "#expression-amount-min" ).val(0);
        jQuery( "#expression-amount-max" ).val(0);
        document.getElementById("gene-expression-filter-histogram").innerHTML = "An error occured while retrieving the histogram values: " + result.responseText;
    }
</script>
<div style="..." id="gene-expr-filter-main">
    <table>
        <tr><td colspan="3">Platform: <span id="gene-expr-filter-gplid"></span></td></tr>
        <tr><td colspan="3"><label for="gene-searchbox">Gene: </label><input type="text" id="gene-searchbox" size="5"/>
            <input type="radio" name="gene-expression-projection" value="ZSCORE" onclick="geneExprFilterProjectionChanged()" checked>Z-Score
                <input type="radio" name="gene-expression-projection" value="LOG_INTENSITY" onclick="geneExprFilterProjectionChanged()">Log</td></tr>
        <tr id="gene-expression-slider-row1"><td colspan="3">Number of subjects selected: <span id="gene-expr-filter-subjectcount">0</span></td></tr>
        <tr id="gene-expression-slider-row2"><td colspan="3">Select the range for expression values:</td></tr>
        <tr id="gene-expression-slider-row3" style="display: none;"><td><input type="text" size="2" id="expression-amount-min" style="color:#548cff; font-weight:bold;"></td>
            <td><div id="gene-expression-range"></div></td>
            <td><input type="text" size="2" id="expression-amount-max" style="color:#548cff; font-weight:bold;"></td></tr>
        <tr id="gene-expression-slider-row4"><td colspan="3">Histogram:</td></tr>
        <tr><td colspan="3"><div id="gene-expression-filter-histogram"></div></td></tr>
    </table>
</div>
</body>
</html>
